using System;
using System.ComponentModel;
using System.Drawing;
using System.IO;
using System.Media;
using System.Runtime.InteropServices;
using System.Windows.Forms;
using Troll_Program.Properties;

namespace Troll_Program
{
    public class Troll : Form
    {
        private IContainer components = null;
        public static Bitmap trollfaceOriginal;
        public static Bitmap trollfaceRotated;
        public static int times = 0;
        public static bool debug = false;
        public static Graphics graphics;
        public static Bitmap newBitmap;
        public static Point trollfaceLocation;
        public static int time = 0;
        public static Stream musicStream = new MemoryStream();
        public static SoundPlayer music = new SoundPlayer(Troll.musicStream);
        protected override CreateParams CreateParams
        {
            get
            {
                CreateParams createParams = base.CreateParams;
                createParams.ExStyle |= 128;
                return createParams;
            }
        }
        protected override void Dispose(bool disposing)
        {
            if (disposing && this.components != null)
            {
                this.components.Dispose();
            }
            base.Dispose(disposing);
        }
        private void InitializeComponent()
        {
            this.SuspendLayout();
            // 
            // Troll
            // 
            this.ClientSize = new System.Drawing.Size(183, 238);
            this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.None;
            this.Name = "Troll";
            this.Text = "Form1";
            this.ResumeLayout(false);

        }
        public Troll()
        {
            this.InitializeComponent();
            this.DoubleBuffered = true;
            base.Size = new Size(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height + 100);
            base.TopMost = true;
            base.FormBorderStyle = FormBorderStyle.None;
            base.ControlBox = false;
            base.DesktopLocation = new Point(0, 0);
            base.MinimizeBox = (base.MaximizeBox = false);
            this.MinimumSize = (this.MaximumSize = base.Size);
            base.TransparencyKey = (this.BackColor = Color.Red);
            base.ShowInTaskbar = false;
            Troll.musicStream = new MemoryStream(Resources.BarrelRoll);
            Troll.music.Stream.Seek(0L, SeekOrigin.Begin);
            Troll.trollfaceOriginal = Resources.Trollface;
            Troll.trollfaceRotated = Troll.trollfaceOriginal;
            Troll.trollfaceLocation = new Point(base.Width / 2 - 540, -90);
            int windowLong = Troll.GetWindowLong(base.Handle, -20);
            Troll.SetWindowLong(base.Handle, -20, windowLong | 524288 | 32);
        }
        [DllImport("user32.dll", SetLastError = true)]
        private static extern int GetWindowLong(IntPtr hWnd, int nIndex);
        [DllImport("user32.dll")]
        private static extern int SetWindowLong(IntPtr hWnd, int nIndex, int dwNewLong);
        protected override void OnPaint(PaintEventArgs e)
        {
            base.OnPaint(e);
            if (Troll.time == -1)
            {
                Troll.trollfaceRotated = Troll.RotateImageByAngle(Troll.trollfaceOriginal, (float)(Troll.times * 10));
                e.Graphics.DrawImage(Troll.trollfaceRotated, Troll.trollfaceLocation);
                if (Troll.times < 35)
                {
                    Troll.times++;
                }
                else
                {
                    Troll.times = 0;
                }
            }
            else
            {
                if (Troll.time < 60)
                {
                    e.Graphics.DrawString("SUDDENLY", new Font("Arial", 128f), Brushes.Blue, new PointF(10f, (float)(base.Height / 2 - 64)));
                    Troll.time++;
                }
                else
                {
                    if (Troll.time < 100)
                    {
                        e.Graphics.DrawString("A", new Font("Arial", 128f), Brushes.Blue, new PointF(10f, (float)(base.Height / 2 - 64)));
                        Troll.time++;
                    }
                    else
                    {
                        if (Troll.time < 260)
                        {
                            e.Graphics.DrawString("TROLLFACE", new Font("Arial", 128f), Brushes.Blue, new PointF(10f, (float)(base.Height / 2 - 64)));
                            Troll.time++;
                        }
                        else
                        {
                            Troll.music.PlayLooping();
                            Troll.time = -1;
                        }
                    }
                }
            }
            base.TopMost = true;
            base.Invalidate();
        }
        public static Bitmap RotateImageByAngle(Image oldBitmap, float angle)
        {
            Troll.newBitmap = new Bitmap(oldBitmap.Width, oldBitmap.Height);
            Troll.graphics = Graphics.FromImage(Troll.newBitmap);
            Troll.graphics.TranslateTransform((float)oldBitmap.Width / 2f, (float)oldBitmap.Height / 2f);
            Troll.graphics.RotateTransform(angle);
            Troll.graphics.TranslateTransform(-(float)oldBitmap.Width / 2f, -(float)oldBitmap.Height / 2f);
            Troll.graphics.DrawImage(oldBitmap, new Point(0, 0));
            return Troll.newBitmap;
        }
    }
}
